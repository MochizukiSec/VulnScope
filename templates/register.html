<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册 - VulnScope</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="gradient-bg security-pattern">
    <!-- 背景装饰 -->
    <div class="position-fixed w-100 h-100" style="pointer-events: none; z-index: -1;">
        <div class="position-absolute top-0 start-0 w-25 h-25 rounded-circle float-animation" 
             style="background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%); left: 10%; top: 20%;"></div>
        <div class="position-absolute top-0 end-0 w-25 h-25 rounded-circle float-animation" 
             style="background: radial-gradient(circle, rgba(147, 51, 234, 0.1) 0%, transparent 70%); right: 10%; top: 60%; animation-delay: -2s;"></div>
        <div class="position-absolute bottom-0 start-0 w-25 h-25 rounded-circle float-animation" 
             style="background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%); left: 60%; bottom: 20%; animation-delay: -4s;"></div>
    </div>

    <div class="container-fluid vh-100 d-flex align-items-center justify-content-center page-transition py-4">
        <div class="row w-100 justify-content-center">
            <div class="col-12 col-md-8 col-lg-6 col-xl-5">
                <div class="card login-card border-0 shadow-lg rounded-4">
                    <div class="card-body p-4 p-md-5">
                        <!-- Logo 和品牌 -->
                        <div class="text-center mb-4">
                            <div class="logo-container mb-3">
                                <i class="fas fa-shield-alt fa-3x text-primary pulse-animation"></i>
                            </div>
                            <h1 class="h3 fw-bold text-dark mb-2">加入 VulnScope</h1>
                            <p class="text-muted small">创建账户，开始您的安全之旅</p>
                        </div>
                        
                        <!-- 注册表单 -->
                        <form id="registerForm" class="needs-validation" novalidate>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" id="firstName" name="firstName" class="form-control" 
                                               placeholder=" " required>
                                        <label for="firstName" class="form-label">名字</label>
                                        <div class="invalid-feedback">请输入名字</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" id="lastName" name="lastName" class="form-control" 
                                               placeholder=" " required>
                                        <label for="lastName" class="form-label">姓氏</label>
                                        <div class="invalid-feedback">请输入姓氏</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group mb-3">
                                <input type="text" id="username" name="username" class="form-control" 
                                       placeholder=" " required minlength="3" maxlength="20" autocomplete="username">
                                <label for="username" class="form-label">用户名</label>
                                <div class="invalid-feedback">用户名长度应为3-20个字符</div>
                                <div class="valid-feedback">用户名可用</div>
                            </div>
                            
                            <div class="input-group mb-3">
                                <input type="email" id="email" name="email" class="form-control" 
                                       placeholder=" " required autocomplete="email">
                                <label for="email" class="form-label">邮箱地址</label>
                                <div class="invalid-feedback">请输入有效的邮箱地址</div>
                                <div class="valid-feedback">邮箱格式正确</div>
                            </div>
                            
                            <div class="input-group mb-3">
                                <input type="password" id="password" name="password" class="form-control" 
                                       placeholder=" " required minlength="8" autocomplete="new-password">
                                <label for="password" class="form-label">密码</label>
                                <button type="button" class="btn btn-outline-secondary border-start-0" 
                                        id="togglePassword" style="border-left: none !important;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <div class="invalid-feedback">密码至少8位，包含字母和数字</div>
                            </div>
                            
                            <!-- 密码强度指示器 -->
                            <div class="strength-indicator mb-3">
                                <div class="strength-bar" id="strengthBar"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">密码强度:</small>
                                <small id="strengthText" class="text-muted">-</small>
                            </div>
                            
                            <div class="input-group mb-3">
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" 
                                       placeholder=" " required autocomplete="new-password">
                                <label for="confirmPassword" class="form-label">确认密码</label>
                                <div class="invalid-feedback">密码不匹配</div>
                                <div class="valid-feedback">密码匹配</div>
                            </div>
                            
                            <div class="input-group mb-4">
                                <select id="role" name="role" class="form-select" required>
                                    <option value="">请选择您的角色</option>
                                    <option value="SecurityAnalyst">安全分析师</option>
                                    <option value="SecurityEngineer">安全运营工程师</option>
                                    <option value="Viewer">查看者</option>
                                </select>
                                <label for="role" class="form-label">角色</label>
                                <div class="invalid-feedback">请选择您的角色</div>
                            </div>
                            
                            <!-- 条款和隐私 -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" name="agreeTerms" required>
                                <label class="form-check-label small" for="agreeTerms">
                                    我已阅读并同意
                                    <a href="#" class="text-primary text-decoration-none">服务条款</a>
                                    和
                                    <a href="#" class="text-primary text-decoration-none">隐私政策</a>
                                </label>
                                <div class="invalid-feedback">请同意服务条款和隐私政策</div>
                            </div>
                            
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="newsletter" name="newsletter">
                                <label class="form-check-label small text-muted" for="newsletter">
                                    接收产品更新和安全情报通知（可选）
                                </label>
                            </div>
                            
                            <!-- 注册按钮 -->
                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-4 fw-semibold" id="registerBtn">
                                <span class="btn-text">创建账户</span>
                                <div class="loading-spinner d-none"></div>
                            </button>
                            

                        </form>
                        
                        <!-- 登录链接 -->
                        <div class="text-center">
                            <p class="small text-muted mb-0">
                                已有账户？
                                <a href="/login" class="text-decoration-none text-primary fw-semibold">立即登录</a>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- 底部链接 -->
                <div class="text-center mt-4">
                    <div class="d-flex justify-content-center gap-4 flex-wrap">
                        <a href="#" class="small text-white text-decoration-none opacity-75">隐私政策</a>
                        <a href="#" class="small text-white text-decoration-none opacity-75">服务条款</a>
                        <a href="#" class="small text-white text-decoration-none opacity-75">帮助中心</a>
                    </div>
                    <p class="small text-white opacity-50 mt-2 mb-0">© 2024 VulnScope. All rights reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notification-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 密码显示/隐藏切换
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        });

        // 密码强度检查
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            const strength = calculatePasswordStrength(password);
            
            // 移除所有强度类
            strengthBar.className = 'strength-bar';
            
            if (password.length === 0) {
                strengthText.textContent = '-';
                return;
            }
            
            switch(strength.level) {
                case 1:
                    strengthBar.classList.add('strength-weak');
                    strengthText.textContent = '弱';
                    strengthText.className = 'text-danger';
                    break;
                case 2:
                    strengthBar.classList.add('strength-fair');
                    strengthText.textContent = '一般';
                    strengthText.className = 'text-warning';
                    break;
                case 3:
                    strengthBar.classList.add('strength-good');
                    strengthText.textContent = '良好';
                    strengthText.className = 'text-info';
                    break;
                case 4:
                    strengthBar.classList.add('strength-strong');
                    strengthText.textContent = '强';
                    strengthText.className = 'text-success';
                    break;
                default:
                    strengthText.textContent = '太弱';
                    strengthText.className = 'text-muted';
            }
        });

        // 密码强度计算函数
        function calculatePasswordStrength(password) {
            let score = 0;
            let level = 0;
            
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            
            if (score < 3) level = 1;
            else if (score < 4) level = 2;
            else if (score < 5) level = 3;
            else level = 4;
            
            return { score, level };
        }

        // 确认密码验证
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.setCustomValidity('密码不匹配');
                this.classList.add('form-error');
                this.classList.remove('form-success');
            } else if (confirmPassword) {
                this.setCustomValidity('');
                this.classList.remove('form-error');
                this.classList.add('form-success');
            } else {
                this.setCustomValidity('');
                this.classList.remove('form-error', 'form-success');
            }
        });

        // 用户名可用性检查
        let usernameTimeout;
        document.getElementById('username').addEventListener('input', function() {
            const username = this.value;
            clearTimeout(usernameTimeout);
            
            if (username.length >= 3) {
                usernameTimeout = setTimeout(() => {
                    checkUsernameAvailability(username);
                }, 500);
            }
        });

        // 检查用户名可用性
        async function checkUsernameAvailability(username) {
            try {
                const response = await fetch(`/api/auth/check-username?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                const usernameInput = document.getElementById('username');
                
                if (data.available) {
                    usernameInput.classList.remove('form-error');
                    usernameInput.classList.add('form-success');
                    usernameInput.setCustomValidity('');
                } else {
                    usernameInput.classList.add('form-error');
                    usernameInput.classList.remove('form-success');
                    usernameInput.setCustomValidity('用户名已被使用');
                }
            } catch (error) {
                console.error('Username check error:', error);
            }
        }

        // 表单验证和提交
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(this);
            const registerBtn = document.getElementById('registerBtn');
            const btnText = registerBtn.querySelector('.btn-text');
            const spinner = registerBtn.querySelector('.loading-spinner');
            
            // 显示加载状态
            registerBtn.disabled = true;
            btnText.textContent = '创建中...';
            spinner.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.get('username'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        role: formData.get('role'),
                        newsletter: formData.has('newsletter')
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('注册成功！正在跳转到登录页面...', 'success');
                    
                    // 延迟跳转以显示成功消息
                    setTimeout(() => {
                        window.location.href = '/login?registered=true';
                    }, 2000);
                } else {
                    showNotification(data.message || '注册失败，请重试', 'error');
                    
                    // 添加错误动画
                    const inputs = this.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (!input.checkValidity()) {
                            input.classList.add('form-error');
                            setTimeout(() => input.classList.remove('form-error'), 500);
                        }
                    });
                }
            } catch (error) {
                console.error('Register error:', error);
                showNotification('网络错误，请检查连接', 'error');
            } finally {
                // 恢复按钮状态
                registerBtn.disabled = false;
                btnText.textContent = '创建账户';
                spinner.classList.add('d-none');
            }
        });

        // 输入框获得焦点时的动画
        document.querySelectorAll('.form-control, .form-select').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                if (!this.value) {
                    this.parentElement.classList.remove('focused');
                }
            });
        });

        // 通知函数
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} me-2"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%) scale(0.8)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // 获取通知图标
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // 实时验证
        document.querySelectorAll('input[required]').forEach(input => {
            input.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('form-error');
                    if (this.value) {
                        this.classList.add('form-success');
                    }
                } else {
                    this.classList.remove('form-success');
                }
            });
        });

        // 页面加载完成后检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (token) {
                // 验证 token 是否有效
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/';
                    }
                })
                .catch(console.error);
            }
        });
    </script>
</body>
</html> 